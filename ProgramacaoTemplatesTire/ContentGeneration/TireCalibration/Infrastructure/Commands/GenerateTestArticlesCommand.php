<?php

namespace Src\ContentGeneration\TireCalibration\Infrastructure\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Src\ContentGeneration\TireCalibration\Application\Services\TestArticleService;
use Carbon\Carbon;

/**
 * GenerateTestArticlesCommand - Gera√ß√£o de artigos mock para valida√ß√£o
 * 
 * Command para desenvolvimento e testes:
 * - Gera artigos de teste em formato JSON
 * - Valida estrutura antes da implementa√ß√£o
 * - Testa templates diferentes
 * - Debug da arquitetura sem dados reais
 * 
 * ‚ö†Ô∏è IMPORTANTE: Apenas para desenvolvimento, n√£o produ√ß√£o
 * 
 * USO:
 * php artisan tire-calibration:generate-test-articles
 * php artisan tire-calibration:generate-test-articles --category=sedan
 * php artisan tire-calibration:generate-test-articles --save-to-disk
 * php artisan tire-calibration:generate-test-articles --validate-only
 * 
 * @author Claude Sonnet 4
 * @version 1.0
 */
class GenerateTestArticlesCommand extends Command
{
    /**
     * The name and signature of the console command.
     */
    protected $signature = 'tire-calibration:generate-test-articles
                            {--category= : Gerar apenas para categoria espec√≠fica}
                            {--save-to-disk : Salvar arquivos JSON no storage}
                            {--validate-only : Apenas validar estrutura dos testes}
                            {--output-path=test-articles : Pasta no storage para salvar arquivos}
                            {--format=json : Formato de sa√≠da (json|table)}';

    /**
     * The console command description.
     */
    protected $description = 'Gerar artigos mock para valida√ß√£o da estrutura e desenvolvimento';

    private TestArticleService $testService;
    
    public function __construct(TestArticleService $testService)
    {
        parent::__construct();
        $this->testService = $testService;
    }

    /**
     * Execute the console command.
     */
    public function handle(): int
    {
        $this->info('üß™ GERANDO ARTIGOS DE TESTE - VALIDA√á√ÉO DA ESTRUTURA');
        $this->info('üìÖ ' . now()->format('d/m/Y H:i:s'));
        $this->newLine();

        try {
            // 1. Obter configura√ß√µes
            $config = $this->getConfig();
            $this->displayConfig($config);

            // 2. Se apenas valida√ß√£o, testar estrutura
            if ($config['validate_only']) {
                return $this->validateTestStructure();
            }

            // 3. Gerar artigos de teste
            $testResults = $this->generateTestArticles($config);

            // 4. Validar artigos gerados
            $validationResults = $this->validateGeneratedArticles($testResults);

            // 5. Salvar em disco se solicitado
            if ($config['save_to_disk']) {
                $this->saveTestArticlesToDisk($testResults, $config);
            }

            // 6. Exibir resultados
            $this->displayResults($testResults, $validationResults, $config);

            Log::info('GenerateTestArticlesCommand: Execu√ß√£o conclu√≠da', [
                'articles_generated' => count($testResults),
                'validation_results' => $validationResults['summary'],
                'config' => $config
            ]);

            return self::SUCCESS;

        } catch (\Exception $e) {
            $this->error('‚ùå Erro durante gera√ß√£o: ' . $e->getMessage());
            Log::error('GenerateTestArticlesCommand: Erro fatal', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return self::FAILURE;
        }
    }

    /**
     * Obter configura√ß√µes do command
     */
    private function getConfig(): array
    {
        $category = $this->option('category');
        $outputPath = $this->option('output-path');
        $format = $this->option('format');

        // Valida√ß√µes
        $validCategories = ['sedan', 'suv', 'hatch', 'pickup', 'motorcycle', 'car_electric'];
        if ($category && !in_array($category, $validCategories)) {
            throw new \InvalidArgumentException("Categoria inv√°lida. Dispon√≠veis: " . implode(', ', $validCategories));
        }

        $validFormats = ['json', 'table'];
        if (!in_array($format, $validFormats)) {
            throw new \InvalidArgumentException("Formato inv√°lido. Dispon√≠veis: " . implode(', ', $validFormats));
        }

        return [
            'category' => $category,
            'save_to_disk' => $this->option('save-to-disk'),
            'validate_only' => $this->option('validate-only'),
            'output_path' => $outputPath,
            'format' => $format,
        ];
    }

    /**
     * Exibir configura√ß√£o
     */
    private function displayConfig(array $config): void
    {
        $this->info('‚öôÔ∏è  CONFIGURA√á√ÉO DE TESTE:');
        $this->line("   ‚Ä¢ Categoria: " . ($config['category'] ?? 'Todas (6 categorias)'));
        $this->line("   ‚Ä¢ Salvar em disco: " . ($config['save_to_disk'] ? '‚úÖ SIM' : '‚ùå N√ÉO'));
        $this->line("   ‚Ä¢ Validar apenas: " . ($config['validate_only'] ? '‚úÖ SIM' : '‚ùå N√ÉO'));
        $this->line("   ‚Ä¢ Pasta de sa√≠da: {$config['output_path']}/");
        $this->line("   ‚Ä¢ Formato: {$config['format']}");
        $this->newLine();
    }

    /**
     * Validar apenas estrutura de teste
     */
    private function validateTestStructure(): int
    {
        $this->info('üîç VALIDANDO ESTRUTURA DE TESTE...');
        $this->newLine();

        try {
            $stats = $this->testService->getTestStats();
            
            $this->info('üìä ESTAT√çSTICAS DE TESTE:');
            $this->line("   ‚Ä¢ Categorias dispon√≠veis: " . count($stats['available_categories']));
            $this->line("   ‚Ä¢ Ve√≠culos de teste: {$stats['total_test_vehicles']}");
            $this->line("   ‚Ä¢ Templates dispon√≠veis: " . count($stats['template_types']));
            $this->line("   ‚Ä¢ Vers√£o do servi√ßo: {$stats['service_version']}");
            $this->newLine();

            $this->info('üóÇÔ∏è  CATEGORIAS DE TESTE:');
            foreach ($stats['available_categories'] as $category) {
                $this->line("   ‚Ä¢ {$category}");
            }
            $this->newLine();

            $this->info('üé® TEMPLATES DISPON√çVEIS:');
            foreach ($stats['template_types'] as $template) {
                $this->line("   ‚Ä¢ {$template}");
            }
            $this->newLine();

            $this->info('‚úÖ Estrutura de teste v√°lida e pronta para uso!');
            return self::SUCCESS;

        } catch (\Exception $e) {
            $this->error('‚ùå Erro na valida√ß√£o da estrutura: ' . $e->getMessage());
            return self::FAILURE;
        }
    }

    /**
     * Gerar artigos de teste
     */
    private function generateTestArticles(array $config): array
    {
        $this->info('üè≠ GERANDO ARTIGOS DE TESTE...');
        $this->newLine();

        $testResults = [];

        if ($config['category']) {
            // Gerar apenas categoria espec√≠fica
            $this->line("üìù Gerando artigo de teste: {$config['category']}");
            try {
                $testResults[$config['category']] = $this->testService->generateTestArticle($config['category']);
                $this->info("   ‚úÖ {$config['category']}: Gerado com sucesso");
            } catch (\Exception $e) {
                $this->error("   ‚ùå {$config['category']}: {$e->getMessage()}");
                $testResults[$config['category']] = ['error' => $e->getMessage()];
            }
        } else {
            // Gerar todas as categorias
            $this->line("üìù Gerando artigos para todas as categorias...");
            $testResults = $this->testService->generateAllTestArticles();
            
            foreach ($testResults as $category => $result) {
                if (isset($result['error'])) {
                    $this->error("   ‚ùå {$category}: {$result['error']}");
                } else {
                    $wordCount = $result['test_metadata']['word_count'] ?? 0;
                    $template = $result['template'] ?? 'N/A';
                    $this->info("   ‚úÖ {$category}: {$wordCount} palavras - Template: {$template}");
                }
            }
        }

        $this->newLine();
        return $testResults;
    }

    /**
     * Validar artigos gerados
     */
    private function validateGeneratedArticles(array $testResults): array
    {
        $this->info('üîç VALIDANDO ARTIGOS GERADOS...');
        $this->newLine();

        $validationResults = [
            'individual' => [],
            'summary' => [
                'total' => 0,
                'valid' => 0,
                'invalid' => 0,
                'errors' => 0,
                'avg_score' => 0
            ]
        ];

        foreach ($testResults as $category => $article) {
            $validationResults['summary']['total']++;

            if (isset($article['error'])) {
                $validationResults['summary']['errors']++;
                $validationResults['individual'][$category] = [
                    'is_valid' => false,
                    'error' => $article['error']
                ];
                continue;
            }

            try {
                $validation = $this->testService->validateTestArticle($article);
                $validationResults['individual'][$category] = $validation;

                if ($validation['is_valid']) {
                    $validationResults['summary']['valid']++;
                    $this->info("   ‚úÖ {$category}: V√°lido (Score: {$validation['structure_score']}/100)");
                } else {
                    $validationResults['summary']['invalid']++;
                    $this->warn("   ‚ö†Ô∏è  {$category}: Inv√°lido - " . count($validation['errors']) . " erro(s)");
                }

                $validationResults['summary']['avg_score'] += $validation['structure_score'];

                // Mostrar warnings se houver
                if (!empty($validation['warnings'])) {
                    foreach ($validation['warnings'] as $warning) {
                        $this->line("      ‚Ä¢ Warning: {$warning}");
                    }
                }

            } catch (\Exception $e) {
                $validationResults['summary']['errors']++;
                $validationResults['individual'][$category] = [
                    'is_valid' => false,
                    'error' => $e->getMessage()
                ];
                $this->error("   ‚ùå {$category}: Erro na valida√ß√£o - {$e->getMessage()}");
            }
        }

        // Calcular score m√©dio
        if ($validationResults['summary']['total'] > 0) {
            $validationResults['summary']['avg_score'] = round(
                $validationResults['summary']['avg_score'] / $validationResults['summary']['total'],
                1
            );
        }

        $this->newLine();
        return $validationResults;
    }

    /**
     * Salvar artigos em disco
     */
    private function saveTestArticlesToDisk(array $testResults, array $config): void
    {
        $this->info('üíæ SALVANDO ARTIGOS EM DISCO...');
        $this->newLine();

        $outputPath = $config['output_path'];
        $timestamp = now()->format('Y-m-d_H-i-s');

        try {
            // Criar diret√≥rio se n√£o existir
            if (!Storage::disk('local')->exists($outputPath)) {
                Storage::disk('local')->makeDirectory($outputPath);
            }

            $savedFiles = [];

            foreach ($testResults as $category => $article) {
                if (isset($article['error'])) {
                    continue; // Pular artigos com erro
                }

                $filename = "{$outputPath}/test_article_{$category}_{$timestamp}.json";
                
                // Adicionar metadados de arquivo
                $article['_file_metadata'] = [
                    'generated_at' => now()->toISOString(),
                    'category' => $category,
                    'filename' => $filename,
                    'command' => 'tire-calibration:generate-test-articles'
                ];

                $jsonContent = json_encode($article, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
                Storage::disk('local')->put($filename, $jsonContent);

                $savedFiles[] = $filename;
                $this->line("   ‚úÖ {$category}: storage/app/{$filename}");
            }

            // Salvar √≠ndice dos arquivos
            $indexFile = "{$outputPath}/index_{$timestamp}.json";
            $index = [
                'generated_at' => now()->toISOString(),
                'command' => 'tire-calibration:generate-test-articles',
                'total_files' => count($savedFiles),
                'files' => $savedFiles,
                'categories' => array_keys($testResults)
            ];

            Storage::disk('local')->put($indexFile, json_encode($index, JSON_PRETTY_PRINT));
            $this->info("   üìã √çndice: storage/app/{$indexFile}");

        } catch (\Exception $e) {
            $this->error("‚ùå Erro ao salvar arquivos: {$e->getMessage()}");
        }

        $this->newLine();
    }

    /**
     * Exibir resultados finais
     */
    private function displayResults(array $testResults, array $validationResults, array $config): void
    {
        $this->info('üìà RESULTADOS DOS TESTES:');
        $this->newLine();

        // Estat√≠sticas de valida√ß√£o
        $summary = $validationResults['summary'];
        $this->line("üìä <fg=blue>Total gerado:</fg=blue> {$summary['total']}");
        $this->line("‚úÖ <fg=green>V√°lidos:</fg=green> {$summary['valid']}");
        $this->line("‚ö†Ô∏è  <fg=yellow>Inv√°lidos:</fg=yellow> {$summary['invalid']}");
        $this->line("‚ùå <fg=red>Erros:</fg=red> {$summary['errors']}");
        $this->line("üéØ <fg=magenta>Score m√©dio:</fg=magenta> {$summary['avg_score']}/100");
        $this->newLine();

        // Estat√≠sticas de conte√∫do
        $totalWords = 0;
        $templates = [];
        
        foreach ($testResults as $category => $article) {
            if (!isset($article['error'])) {
                $totalWords += $article['test_metadata']['word_count'] ?? 0;
                $templates[] = $article['template'] ?? 'unknown';
            }
        }

        $avgWords = count($testResults) > 0 ? round($totalWords / count($testResults)) : 0;
        $uniqueTemplates = array_unique($templates);

        $this->line("üìù <fg=cyan>Palavras total:</fg=cyan> {$totalWords}");
        $this->line("üìñ <fg=cyan>M√©dia por artigo:</fg=cyan> {$avgWords} palavras");
        $this->line("üé® <fg=cyan>Templates usados:</fg=cyan> " . count($uniqueTemplates) . " (" . implode(', ', $uniqueTemplates) . ")");
        $this->newLine();

        // Mostrar detalhes por categoria se formato table
        if ($config['format'] === 'table' && !empty($testResults)) {
            $this->displayResultsTable($testResults, $validationResults);
        }

        // Recomenda√ß√µes
        $this->displayRecommendations($validationResults);
    }

    /**
     * Exibir resultados em tabela
     */
    private function displayResultsTable(array $testResults, array $validationResults): void
    {
        $tableData = [];

        foreach ($testResults as $category => $article) {
            $validation = $validationResults['individual'][$category] ?? [];

            if (isset($article['error'])) {
                $tableData[] = [
                    'Categoria' => $category,
                    'Status' => '‚ùå Erro',
                    'Palavras' => '-',
                    'Template' => '-',
                    'Score' => '-',
                    'Observa√ß√µes' => substr($article['error'], 0, 50) . '...'
                ];
            } else {
                $status = ($validation['is_valid'] ?? false) ? '‚úÖ V√°lido' : '‚ö†Ô∏è Inv√°lido';
                $words = $article['test_metadata']['word_count'] ?? 0;
                $template = $article['template'] ?? 'N/A';
                $score = $validation['structure_score'] ?? 0;
                $observations = '';

                if (!empty($validation['warnings'])) {
                    $observations = count($validation['warnings']) . ' warning(s)';
                } elseif (!empty($validation['errors'])) {
                    $observations = count($validation['errors']) . ' erro(s)';
                } else {
                    $observations = 'OK';
                }

                $tableData[] = [
                    'Categoria' => $category,
                    'Status' => $status,
                    'Palavras' => $words,
                    'Template' => $template,
                    'Score' => $score . '/100',
                    'Observa√ß√µes' => $observations
                ];
            }
        }

        $this->table(
            ['Categoria', 'Status', 'Palavras', 'Template', 'Score', 'Observa√ß√µes'],
            $tableData
        );
        $this->newLine();
    }

    /**
     * Exibir recomenda√ß√µes
     */
    private function displayRecommendations(array $validationResults): void
    {
        $summary = $validationResults['summary'];
        
        $this->info('üí° RECOMENDA√á√ïES:');

        if ($summary['valid'] === $summary['total']) {
            $this->line('   ‚úÖ Todos os artigos de teste est√£o v√°lidos!');
            $this->line('   ‚úÖ Estrutura JSON est√° consistente');
            $this->line('   ‚úÖ Pronto para implementa√ß√£o na arquitetura');
        } else {
            $this->line('   ‚ö†Ô∏è  Alguns artigos t√™m problemas:');
            
            if ($summary['invalid'] > 0) {
                $this->line('   ‚Ä¢ Verifique campos obrigat√≥rios ausentes');
                $this->line('   ‚Ä¢ Ajuste valida√ß√µes no TestArticleService');
            }
            
            if ($summary['errors'] > 0) {
                $this->line('   ‚Ä¢ Corrija erros de gera√ß√£o no TestArticleService');
                $this->line('   ‚Ä¢ Verifique logs para detalhes');
            }
        }

        if ($summary['avg_score'] < 80) {
            $this->line('   ‚Ä¢ Score m√©dio baixo - melhore estrutura dos templates');
        }

        $this->newLine();
        $this->info('üöÄ PR√ìXIMOS PASSOS:');
        $this->line('   1. Ajuste TestArticleService se necess√°rio');
        $this->line('   2. Execute: php artisan tire-calibration:generate-articles');
        $this->line('   3. Compare estrutura real vs. teste');
        $this->line('   4. Monitore: php artisan tire-calibration:stats');
    }
}