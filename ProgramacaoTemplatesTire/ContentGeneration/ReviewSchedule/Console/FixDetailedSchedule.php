<?php

namespace Src\ContentGeneration\ReviewSchedule\Console;

use Illuminate\Console\Command;
use Src\ContentGeneration\ReviewSchedule\Infrastructure\Eloquent\ReviewScheduleArticle;
use Src\ContentGeneration\ReviewSchedule\Infrastructure\ContentTemplates\CarMaintenanceTemplate;
use Src\ContentGeneration\ReviewSchedule\Infrastructure\ContentTemplates\MotorcycleMaintenanceTemplate;
use Src\ContentGeneration\ReviewSchedule\Infrastructure\ContentTemplates\ElectricVehicleMaintenanceTemplate;
use Src\ContentGeneration\ReviewSchedule\Infrastructure\ContentTemplates\HybridVehicleMaintenanceTemplate;

class FixDetailedSchedule extends Command
{
    /**
     * The name and signature of the console command.
     */
    protected $signature = 'review-schedule:fix-detailed-schedule 
                            {--limit=100 : Limit number of articles to fix}
                            {--dry-run : Show what would be fixed without saving}
                            {--vehicle-type= : Filter by vehicle type}
                            {--force : Fix even if schedule exists but incomplete}';

    /**
     * The console command description.
     */
    protected $description = 'Fix missing cronograma_detalhado fields using templates';

    private array $fixedArticles = [];
    private array $statistics = [
        'total_processed' => 0,
        'total_fixed' => 0,
        'already_complete' => 0,
        'fix_errors' => 0,
        'fixes_by_type' => []
    ];

    public function handle()
    {
        $limit = (int)$this->option('limit');
        $dryRun = $this->option('dry-run');
        $vehicleType = $this->option('vehicle-type');
        $force = $this->option('force');

        $this->info($dryRun ? 'üîç SIMULA√á√ÉO de corre√ß√£o do cronograma_detalhado...' : 'üîß Corrigindo cronograma_detalhado...');

        $query = ReviewScheduleArticle::limit($limit);
        
        if ($vehicleType) {
            $this->info("üîç Filtrando por tipo: {$vehicleType}");
        }

        $articles = $query->get();
        $this->info("üìä Processando {$articles->count()} artigos...");
        
        $progressBar = $this->output->createProgressBar($articles->count());
        $progressBar->start();

        foreach ($articles as $article) {
            $this->processArticle($article, $dryRun, $vehicleType, $force);
            $this->statistics['total_processed']++;
            $progressBar->advance();
        }

        $progressBar->finish();
        $this->newLine(2);

        $this->displayResults($dryRun);
    }

    private function processArticle($article, bool $dryRun, ?string $vehicleTypeFilter, bool $force): void
    {
        $content = $this->getContentArray($article);
        
        if (!$content) {
            return;
        }

        $vehicleInfo = $content['extracted_entities'] ?? [];
        $vehicleType = strtolower($vehicleInfo['tipo_veiculo'] ?? 'car');

        // Aplicar filtro se especificado
        if ($vehicleTypeFilter && !$this->matchesVehicleType($vehicleType, $vehicleTypeFilter)) {
            return;
        }

        try {
            $fixedContent = $this->fixScheduleContent($content, $vehicleInfo, $vehicleType);
            
            if ($dryRun) {
                $this->recordFixPreview($article, $content, $fixedContent, $vehicleInfo);
            } else {
                $this->saveFixedArticle($article, $fixedContent);
            }
            
            $this->statistics['total_fixed']++;
            $this->recordFixByType($vehicleType);
            
        } catch (\Exception $e) {
            $this->statistics['fix_errors']++;
            $this->warn("Erro ao corrigir artigo {$article->_id}: {$e->getMessage()}");
        }
    }

    private function getContentArray($article): ?array
    {
        $content = $article->content;
        
        if (is_array($content)) {
            return $content;
        }
        
        if (is_string($content)) {
            $decoded = json_decode($content, true);
            return is_array($decoded) ? $decoded : null;
        }
        
        return null;
    }

    private function matchesVehicleType(string $vehicleType, string $filter): bool
    {
        return strpos($vehicleType, strtolower($filter)) !== false;
    }

    private function fixScheduleContent(array $content, array $vehicleInfo, string $vehicleType): array
    {
        // Obter template apropriado
        $template = $this->getTemplateForVehicleType($vehicleType);
        
        // Preparar dados do ve√≠culo
        $vehicleData = [
            'make' => $vehicleInfo['marca'] ?? 'Ve√≠culo',
            'model' => $vehicleInfo['modelo'] ?? 'Gen√©rico',
            'year' => $vehicleInfo['ano'] ?? date('Y'),
            'engine' => $vehicleInfo['motor'] ?? '1.0',
            'vehicle_type' => $vehicleType,
            'fuel_type' => $this->extractFuelType($vehicleInfo)
        ];

        try {
            // Gerar cronograma usando o template (mant√©m estrutura original)
            $newSchedule = $template->generateDetailedSchedule($vehicleData);
            
            // Verificar se o schedule foi gerado corretamente
            if (empty($newSchedule)) {
                throw new \Exception("Template retornou cronograma vazio");
            }
            
            // Verificar se tem a estrutura esperada
            if (!isset($newSchedule[0])) {
                throw new \Exception("Cronograma sem revis√µes");
            }
            
            // Atualizar conte√∫do preservando estrutura do template
            $content['cronograma_detalhado'] = $newSchedule;
            
            return $content;
        } catch (\Exception $e) {
            // Se falhar, criar cronograma b√°sico com estrutura correta
            $content['cronograma_detalhado'] = $this->createBasicScheduleCorrectFormat($vehicleData, $vehicleType);
            return $content;
        }
    }

    private function getTemplateForVehicleType(string $vehicleType): object
    {
        switch ($vehicleType) {
            case 'motorcycle':
            case 'moto':
                return new MotorcycleMaintenanceTemplate();
            
            case 'electric':
            case 'eletrico':
                return new ElectricVehicleMaintenanceTemplate();
            
            case 'hybrid':
            case 'hibrido':
                return new HybridVehicleMaintenanceTemplate();
            
            default:
                return new CarMaintenanceTemplate();
        }
    }

    private function extractFuelType(array $vehicleInfo): string
    {
        $fuelType = strtolower($vehicleInfo['combustivel'] ?? 'flex');
        
        $fuelMap = [
            'gasolina' => 'gasoline',
            'etanol' => 'ethanol',
            'diesel' => 'diesel',
            'flex' => 'flex',
            'eletrico' => 'electric',
            'hibrido' => 'hybrid'
        ];
        
        return $fuelMap[$fuelType] ?? 'flex';
    }

    private function createBasicScheduleCorrectFormat(array $vehicleData, string $vehicleType): array
    {
        $schedule = [];
        $intervals = $this->getBasicIntervals($vehicleType);
        
        foreach ($intervals as $index => $interval) {
            $revisionNumber = $index + 1;
            $schedule[] = [
                'numero_revisao' => $revisionNumber,
                'intervalo' => $interval['intervalo'],
                'km' => $interval['km'],
                'servicos_principais' => $this->getBasicServices($revisionNumber, $vehicleType),
                'verificacoes_complementares' => $this->getBasicChecks($revisionNumber, $vehicleType),
                'estimativa_custo' => $this->getBasicCost($revisionNumber),
                'observacoes' => $this->getBasicObservations($revisionNumber)
            ];
        }
        
        return $schedule;
    }

    private function getBasicIntervals(string $vehicleType): array
    {
        if (in_array($vehicleType, ['motorcycle', 'moto'])) {
            return [
                ['intervalo' => '1.000 km ou 6 meses', 'km' => '1.000'],
                ['intervalo' => '5.000 km ou 12 meses', 'km' => '5.000'],
                ['intervalo' => '10.000 km ou 18 meses', 'km' => '10.000'],
                ['intervalo' => '15.000 km ou 24 meses', 'km' => '15.000'],
                ['intervalo' => '20.000 km ou 30 meses', 'km' => '20.000'],
                ['intervalo' => '25.000 km ou 36 meses', 'km' => '25.000']
            ];
        }
        
        return [
            ['intervalo' => '10.000 km ou 12 meses', 'km' => '10.000'],
            ['intervalo' => '20.000 km ou 24 meses', 'km' => '20.000'],
            ['intervalo' => '30.000 km ou 36 meses', 'km' => '30.000'],
            ['intervalo' => '40.000 km ou 48 meses', 'km' => '40.000'],
            ['intervalo' => '50.000 km ou 60 meses', 'km' => '50.000'],
            ['intervalo' => '60.000 km ou 72 meses', 'km' => '60.000']
        ];
    }

    private function getBasicCost(int $revision): string
    {
        $costs = [
            1 => 'R$ 280 - R$ 350',
            2 => 'R$ 320 - R$ 420',
            3 => 'R$ 380 - R$ 520',
            4 => 'R$ 450 - R$ 650',
            5 => 'R$ 520 - R$ 750',
            6 => 'R$ 600 - R$ 900'
        ];
        
        return $costs[$revision] ?? 'R$ 350 - R$ 500';
    }

    private function getBasicServices(int $revision, string $vehicleType): array
    {
        if (in_array($vehicleType, ['motorcycle', 'moto'])) {
            $services = [
                1 => [
                    'Verifica√ß√£o inicial completa da motocicleta',
                    'Troca do √≥leo lubrificante e filtro',
                    'Ajuste da corrente de transmiss√£o',
                    'Regulagem de v√°lvulas se necess√°rio'
                ],
                2 => [
                    'Substitui√ß√£o do √≥leo e filtro do motor',
                    'Inspe√ß√£o do sistema de freios',
                    'Lubrifica√ß√£o da corrente',
                    'Verifica√ß√£o do sistema el√©trico'
                ],
                3 => [
                    'Troca de √≥leo e filtro',
                    'Limpeza do filtro de ar',
                    'Regulagem de v√°lvulas',
                    'Verifica√ß√£o da embreagem'
                ]
            ];
        } else {
            $services = [
                1 => [
                    'Verifica√ß√£o minuciosa do sistema de freios',
                    'Substitui√ß√£o do filtro de ar-condicionado',
                    'Diagn√≥stico b√°sico dos sistemas el√©tricos',
                    'Inspe√ß√£o detalhada dos pneum√°ticos'
                ],
                2 => [
                    'Troca de √≥leo e filtro do motor',
                    'Substitui√ß√£o dos filtros de ar e combust√≠vel',
                    'Verifica√ß√£o do sistema de arrefecimento',
                    'Inspe√ß√£o dos freios e pastilhas'
                ],
                3 => [
                    'Substitui√ß√£o do √≥leo lubrificante',
                    'Limpeza do sistema de inje√ß√£o',
                    'Verifica√ß√£o da embreagem',
                    'An√°lise do sistema el√©trico completo'
                ]
            ];
        }
        
        return $services[$revision] ?? $services[1];
    }

    private function getBasicChecks(int $revision, string $vehicleType): array
    {
        if (in_array($vehicleType, ['motorcycle', 'moto'])) {
            return [
                'Verifica√ß√£o da calibragem dos pneus',
                'Teste do sistema de ilumina√ß√£o',
                'Inspe√ß√£o da bateria e terminais',
                'Verifica√ß√£o dos espelhos retrovisores'
            ];
        }
        
        return [
            'Verifica√ß√£o da press√£o dos pneus',
            'Teste da bateria e sistema de carga',
            'Inspe√ß√£o do sistema de ilumina√ß√£o',
            'Verifica√ß√£o dos n√≠veis de fluidos'
        ];
    }

    private function getBasicObservations(int $revision): string
    {
        $observations = [
            1 => 'Primeira revis√£o focada em adapta√ß√£o do ve√≠culo',
            2 => 'Revis√£o de acompanhamento dos sistemas principais',
            3 => 'Manuten√ß√£o preventiva intermedi√°ria',
            4 => 'Revis√£o ampla com aten√ß√£o aos desgastes',
            5 => 'Verifica√ß√£o completa dos sistemas cr√≠ticos',
            6 => 'Revis√£o extensiva com foco na longevidade'
        ];
        
        return $observations[$revision] ?? 'Revis√£o de manuten√ß√£o preventiva';
    }

    private function recordFixPreview($article, array $originalContent, array $fixedContent, array $vehicleInfo): void
    {
        $originalSchedule = $originalContent['cronograma_detalhado'] ?? [];
        $newSchedule = $fixedContent['cronograma_detalhado'] ?? [];
        
        $this->fixedArticles[] = [
            'id' => $article->_id ?? $article->id,
            'title' => $article->title,
            'vehicle' => [
                'marca' => $vehicleInfo['marca'] ?? 'N/A',
                'modelo' => $vehicleInfo['modelo'] ?? 'N/A',
                'ano' => $vehicleInfo['ano'] ?? 'N/A'
            ],
            'original_revisions' => count($originalSchedule),
            'new_revisions' => count($newSchedule),
            'preview' => [
                'first_revision' => $newSchedule[0] ?? null,
                'has_required_fields' => $this->hasRequiredFields($newSchedule[0] ?? [])
            ]
        ];
    }

    private function hasRequiredFields(array $revision): array
    {
        return [
            'numero_revisao' => isset($revision['numero_revisao']),
            'intervalo' => isset($revision['intervalo']),
            'km' => isset($revision['km']),
            'estimativa_custo' => isset($revision['estimativa_custo']),
            'servicos_principais' => isset($revision['servicos_principais']),
            'verificacoes_complementares' => isset($revision['verificacoes_complementares'])
        ];
    }

    private function saveFixedArticle($article, array $fixedContent): void
    {
        try {
            $article->content = $fixedContent;
            $article->updated_at = now();
            $article->save();
        } catch (\Exception $e) {
            throw new \Exception("Erro ao salvar artigo: {$e->getMessage()}");
        }
    }

    private function recordFixByType(string $vehicleType): void
    {
        if (!isset($this->statistics['fixes_by_type'][$vehicleType])) {
            $this->statistics['fixes_by_type'][$vehicleType] = 0;
        }
        $this->statistics['fixes_by_type'][$vehicleType]++;
    }

    private function displayResults(bool $dryRun): void
    {
        $this->info($dryRun ? 'üìã RESULTADO DA SIMULA√á√ÉO:' : '‚úÖ RESULTADO DA CORRE√á√ÉO:');
        
        $this->table(
            ['M√©trica', 'Valor'],
            [
                ['Total Processado', $this->statistics['total_processed']],
                ['Corrigidos', $this->statistics['total_fixed']],
                ['J√° Completos', $this->statistics['already_complete']],
                ['Erros', $this->statistics['fix_errors']]
            ]
        );

        if (!empty($this->statistics['fixes_by_type'])) {
            $this->newLine();
            $this->info('üîß CORRE√á√ïES POR TIPO:');
            $typeTable = [];
            foreach ($this->statistics['fixes_by_type'] as $type => $count) {
                $typeTable[] = [$type, $count];
            }
            $this->table(['Tipo de Ve√≠culo', 'Artigos Corrigidos'], $typeTable);
        }

        // Mostrar exemplos de corre√ß√µes
        if ($dryRun && !empty($this->fixedArticles)) {
            $this->displayFixPreview();
        }

        $this->newLine();
        if ($dryRun) {
            $this->info('üí° Para aplicar as corre√ß√µes, execute sem --dry-run:');
            $this->line('   php artisan review-schedule:fix-detailed-schedule --limit=' . $this->option('limit'));
        } else {
            $this->info("‚úÖ Corre√ß√£o conclu√≠da! {$this->statistics['total_fixed']} artigos foram atualizados.");
            $this->line('üí° Verifique os resultados com:');
            $this->line('   php artisan review-schedule:analyze-detailed-schedule --limit=' . $this->statistics['total_fixed']);
        }
    }

    private function displayFixPreview(): void
    {
        $this->newLine();
        $this->info('üìù PREVIEW DAS CORRE√á√ïES (primeiros 5):');
        
        foreach (array_slice($this->fixedArticles, 0, 5) as $fix) {
            $this->newLine();
            $this->line("ID: {$fix['id']}");
            $this->line("Ve√≠culo: {$fix['vehicle']['marca']} {$fix['vehicle']['modelo']} {$fix['vehicle']['ano']}");
            $this->line("Revis√µes: {$fix['original_revisions']} ‚Üí {$fix['new_revisions']}");
            
            if ($fix['preview']['first_revision']) {
                $fields = $fix['preview']['has_required_fields'];
                $status = [];
                foreach ($fields as $field => $exists) {
                    $status[] = $field . ': ' . ($exists ? '‚úÖ' : '‚ùå');
                }
                $this->line("Campos: " . implode(', ', $status));
            }
            
            $this->line(str_repeat('-', 50));
        }
    }
}