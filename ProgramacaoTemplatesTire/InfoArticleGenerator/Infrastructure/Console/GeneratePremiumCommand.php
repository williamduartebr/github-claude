<?php

namespace Src\InfoArticleGenerator\Infrastructure\Console;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Log;
use Src\InfoArticleGenerator\Infrastructure\Eloquent\TempArticle;
use Src\InfoArticleGenerator\Application\Services\GenerationClaudeApiService;

/**
 * GeneratePremiumCommand - Modelo Premium (Opus)
 * 
 * ‚ö†Ô∏è ATEN√á√ÉO: MUITO CARO!
 * Custo: 4.8x modelo standard
 * 
 * QUANDO USAR:
 * - Artigos que falharam 2+ vezes
 * - Temas extremamente complexos
 * - Artigos flagship/pillar content
 * - Casos cr√≠ticos onde qualidade m√°xima √© essencial
 * 
 * N√ÉO USE PARA:
 * - Artigos comuns/simples
 * - Processamento em massa
 * - Artigos de prioridade baixa/m√©dia
 * 
 * ESTRAT√âGIA:
 * 1. Apenas artigos cr√≠ticos
 * 2. M√°ximo 1-3 artigos por execu√ß√£o
 * 3. Delay alto entre requisi√ß√µes (10s+)
 * 4. Confirmar custo antes de executar
 * 
 * USO:
 * php artisan temp-article:generate-premium --limit=1
 * php artisan temp-article:generate-premium --only-critical
 * php artisan temp-article:generate-premium --force-confirm
 * 
 * @author Claude Sonnet 4
 * @version 1.0
 */
class GeneratePremiumCommand extends Command
{
    protected $signature = 'temp-article:generate-premium
                            {--limit=1 : Quantidade m√°xima (M√ÅXIMO RECOMENDADO: 3)}
                            {--delay=10 : Delay entre requisi√ß√µes (m√≠nimo: 10s)}
                            {--only-critical : Apenas artigos cr√≠ticos (falharam 2+ vezes)}
                            {--priority=high : Prioridade m√≠nima (high apenas)}
                            {--category= : Categoria espec√≠fica}
                            {--dry-run : Simula√ß√£o sem gerar}
                            {--force-confirm : Pular confirma√ß√£o (cuidado!)}
                            {--max-cost=20 : Limite m√°ximo de custo}';

    protected $description = 'Gerar artigos usando modelo PREMIUM (claude-opus) - √öLTIMA INST√ÇNCIA';

    private GenerationClaudeApiService $claudeService;
    private array $stats = [
        'processed' => 0,
        'successful' => 0,
        'failed' => 0,
        'total_cost' => 0.0,
        'total_time' => 0.0
    ];

    public function __construct(GenerationClaudeApiService $claudeService)
    {
        parent::__construct();
        $this->claudeService = $claudeService;
    }

    public function handle(): int
    {
        $startTime = microtime(true);

        $this->displayWarningHeader();

        if (!$this->claudeService->isConfigured()) {
            $this->error('‚ùå Claude API Key n√£o configurada!');
            return self::FAILURE;
        }

        try {
            $limit = min((int) $this->option('limit'), 5); // Limitar a 5 no m√°ximo
            $delay = max((int) $this->option('delay'), 10); // M√≠nimo 10s
            $maxCost = (float) $this->option('max-cost');
            $dryRun = $this->option('dry-run');

            // Validar limite de custo
            if ($limit * 4.8 > $maxCost) {
                $this->error("‚ùå Custo estimado (" . ($limit * 4.8) . ") excede limite ({$maxCost})");
                $this->line("üí° Reduza --limit ou aumente --max-cost");
                return self::FAILURE;
            }

            // Buscar artigos para processar
            $articles = $this->fetchCriticalArticles($limit);

            if ($articles->isEmpty()) {
                $this->info('‚úÖ Nenhum artigo CR√çTICO encontrado para processar com modelo PREMIUM');
                $this->line('üí° Isso √© BOM! Significa que os modelos mais baratos est√£o funcionando.');
                return self::SUCCESS;
            }

            $this->displayArticlesSummary($articles);

            if ($dryRun) {
                $this->warn('üß™ DRY RUN - Nenhuma gera√ß√£o real ser√° executada');
                return self::SUCCESS;
            }

            // Confirma√ß√£o extra de seguran√ßa
            if (!$this->option('force-confirm')) {
                if (!$this->confirmCriticalExecution($articles->count())) {
                    $this->info('‚èπÔ∏è Execu√ß√£o cancelada (decis√£o s√°bia para economizar custos)');
                    return self::SUCCESS;
                }
            }

            // Processar artigos um por um (sem lotes)
            $this->processArticlesSequentially($articles, $delay);

            // Resultados finais
            $this->stats['total_time'] = round(microtime(true) - $startTime, 2);
            $this->displayFinalResults();

            return self::SUCCESS;

        } catch (\Exception $e) {
            $this->error("üí• Erro cr√≠tico: " . $e->getMessage());
            Log::error('GeneratePremiumCommand failed', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'stats' => $this->stats
            ]);
            return self::FAILURE;
        }
    }

    /**
     * Buscar apenas artigos CR√çTICOS
     */
    private function fetchCriticalArticles(int $limit)
    {
        $query = TempArticle::query();

        if ($this->option('only-critical')) {
            // Artigos que falharam 2+ vezes
            $query->where('generation_status', 'failed')
                  ->where('generation_retry_count', '>=', 2);
        } else {
            // Artigos cr√≠ticos: alta prioridade + falharam pelo menos 1x
            $query->where('generation_priority', 'high')
                  ->where(function($q) {
                      $q->where('generation_status', 'failed')
                        ->orWhere(function($subQ) {
                            $subQ->where('generation_status', 'pending')
                                 ->whereNotNull('generation_last_attempt_at');
                        });
                  });
        }

        if ($category = $this->option('category')) {
            $query->where('category_slug', $category);
        }

        return $query->orderBy('generation_retry_count', 'desc')
                    ->orderBy('created_at', 'asc')
                    ->limit($limit)
                    ->get();
    }

    /**
     * Processar artigos sequencialmente (um por vez)
     */
    private function processArticlesSequentially($articles, int $delay): void
    {
        $total = $articles->count();

        foreach ($articles as $index => $article) {
            $current = $index + 1;
            
            $this->info("üîÑ Processando artigo {$current}/{$total} (PREMIUM)");
            $this->newLine();

            $this->processArticle($article);

            // Delay entre requisi√ß√µes (exceto √∫ltimo)
            if ($current < $total) {
                $this->warn("‚è≥ Aguardando {$delay}s antes do pr√≥ximo (economia de custo)...");
                sleep($delay);
                $this->newLine();
            }

            // Mostrar progresso
            $this->displayProgressStats($current, $total);
            $this->newLine();
        }
    }

    /**
     * Processar um artigo individual com modelo PREMIUM
     */
    private function processArticle(TempArticle $article): void
    {
        $articleStartTime = microtime(true);

        $this->line("üìù T√≠tulo: {$article->title}");
        $this->line("   üìÅ Categoria: {$article->category_name} > {$article->subcategory_name}");
        $this->line("   üéØ Prioridade: " . strtoupper($article->generation_priority));
        $this->line("   üí• Tentativas anteriores: " . ($article->generation_retry_count ?? 0));
        $this->line("   ü§ñ Modelos tentados: " . $this->getModelsAttempted($article));
        $this->newLine();

        try {
            // Marcar como gerando
            $article->markAsGenerating('premium');

            $this->warn('   ‚öôÔ∏è Chamando Claude Opus (aguarde ~30-60s)...');

            // Chamar API
            $result = $this->claudeService->generateArticle([
                'title' => $article->title,
                'category_id' => $article->category_id,
                'category_name' => $article->category_name,
                'category_slug' => $article->category_slug,
                'subcategory_id' => $article->subcategory_id,
                'subcategory_name' => $article->subcategory_name,
                'subcategory_slug' => $article->subcategory_slug,
            ], 'premium');

            if ($result['success']) {
                // Sucesso
                $article->markAsGenerated(
                    $result['json'],
                    'premium',
                    $result['cost']
                );

                $executionTime = round(microtime(true) - $articleStartTime, 2);

                $this->info("   üéâ SUCESSO COM MODELO PREMIUM!");
                $this->line("   ‚è±Ô∏è Tempo: {$executionTime}s");
                $this->line("   üí∞ Custo: {$result['cost']} unidades (4.8x standard)");
                $this->line("   üìä Tokens: ~{$result['tokens_estimated']}");
                $this->line("   üìè Blocos gerados: " . count($result['json']['metadata']['content_blocks'] ?? []));

                $this->stats['successful']++;
                $this->stats['total_cost'] += $result['cost'];

            } else {
                // Falha (raro com Opus)
                $article->markAsFailed($result['error'], 'premium');

                $this->error("   ‚ùå FALHA MESMO COM PREMIUM: {$result['error']}");
                $this->warn("   ‚ö†Ô∏è Artigo pode ter problemas fundamentais no t√≠tulo/tema");

                $this->stats['failed']++;
            }

        } catch (\Exception $e) {
            $article->markAsFailed($e->getMessage(), 'premium');
            $this->error("   üí• Exce√ß√£o: " . $e->getMessage());
            $this->stats['failed']++;
        }

        $this->stats['processed']++;
        $this->newLine();
    }

    /**
     * Obter modelos j√° tentados
     */
    private function getModelsAttempted(TempArticle $article): string
    {
        $attempts = $article->generation_attempts ?? [];
        $models = array_unique(array_column($attempts, 'model'));
        return !empty($models) ? implode(' ‚Üí ', $models) : 'nenhum';
    }

    /**
     * Exibir header de aviso
     */
    private function displayWarningHeader(): void
    {
        $this->newLine();
        $this->error('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ATEN√á√ÉO: MODELO PREMIUM (OPUS) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
        $this->newLine();
        $this->warn('üí∞ CUSTO: 4.8x MAIS CARO que modelo standard');
        $this->warn('üéØ USO: Apenas casos CR√çTICOS e complexos');
        $this->warn('‚è±Ô∏è VELOCIDADE: Mais lento (~30-60s por artigo)');
        $this->newLine();
        $this->info('‚úÖ QUANDO USAR:');
        $this->line('   ‚Ä¢ Artigos que falharam 2+ vezes');
        $this->line('   ‚Ä¢ Conte√∫do flagship/pillar');
        $this->line('   ‚Ä¢ Temas extremamente t√©cnicos');
        $this->newLine();
        $this->error('‚ùå N√ÉO USE PARA:');
        $this->line('   ‚Ä¢ Artigos simples/comuns');
        $this->line('   ‚Ä¢ Processamento em massa');
        $this->line('   ‚Ä¢ Primeira tentativa');
        $this->newLine();
    }

    /**
     * Exibir resumo dos artigos cr√≠ticos
     */
    private function displayArticlesSummary($articles): void
    {
        $this->warn('üî¥ ARTIGOS CR√çTICOS PARA PROCESSAMENTO PREMIUM:');
        $this->table(
            ['#', 'T√≠tulo', 'Categoria', 'Tentativas', '√öltimo Modelo', '√öltimo Erro'],
            $articles->map(function($article, $index) {
                $lastError = $article->generation_error ?? 'N/A';
                return [
                    $index + 1,
                    \Illuminate\Support\Str::limit($article->title, 40),
                    $article->category_name,
                    $article->generation_retry_count ?? 0,
                    $article->generation_model_used ?? 'nenhum',
                    \Illuminate\Support\Str::limit($lastError, 30)
                ];
            })
        );
        $this->newLine();
    }

    /**
     * Confirma√ß√£o cr√≠tica de execu√ß√£o
     */
    private function confirmCriticalExecution(int $count): bool
    {
        $estimatedCost = $count * 4.8;
        $estimatedTime = $count * ((int)$this->option('delay') + 45); // delay + ~45s por artigo

        $this->error('üö® CONFIRMA√á√ÉO CR√çTICA DE CUSTOS:');
        $this->newLine();
        $this->line("üìä Artigos: {$count}");
        $this->warn("üí∞ Custo TOTAL: {$estimatedCost} unidades (‚âà " . ($count * 4.8) . "x standard)");
        $this->line("‚è±Ô∏è Tempo estimado: " . gmdate("H:i:s", $estimatedTime));
        $this->line("ü§ñ Modelo: claude-3-opus-20240229");
        $this->newLine();
        
        $this->warn('üí° ALTERNATIVAS MAIS BARATAS:');
        $this->line("   ‚Ä¢ Tentar intermediate: php artisan temp-article:generate-intermediate --limit={$count}");
        $this->line("   ‚Ä¢ Revisar t√≠tulos: pode haver problema nos dados de entrada");
        $this->line("   ‚Ä¢ Aguardar: problemas tempor√°rios da API podem resolver sozinhos");
        $this->newLine();

        $this->error('‚ö†Ô∏è VOC√ä TEM CERTEZA ABSOLUTA?');
        $confirmed = $this->confirm('Prosseguir com modelo PREMIUM (custo 4.8x)?', false);

        if ($confirmed) {
            $this->warn('‚ö†Ô∏è √öLTIMA CHANCE!');
            return $this->confirm('CONFIRMAR NOVAMENTE: Processar com modelo PREMIUM?', false);
        }

        return false;
    }

    /**
     * Progresso durante execu√ß√£o
     */
    private function displayProgressStats(int $current, int $total): void
    {
        $progress = round(($current / $total) * 100, 1);
        $successRate = $this->stats['processed'] > 0 
            ? round(($this->stats['successful'] / $this->stats['processed']) * 100, 1) 
            : 0;

        $this->info("üìä PROGRESSO PREMIUM:");
        $this->line("   üìà Progresso: {$current}/{$total} ({$progress}%)");
        $this->line("   ‚úÖ Sucessos: {$this->stats['successful']}");
        $this->line("   ‚ùå Falhas: {$this->stats['failed']}");
        $this->line("   üìä Taxa: {$successRate}%");
        $this->warn("   üí∞ Custo acumulado: {$this->stats['total_cost']} unidades");
    }

    /**
     * Resultados finais
     */
    private function displayFinalResults(): void
    {
        $this->newLine();
        $this->error('üèÜ RESULTADOS FINAIS - MODELO PREMIUM (OPUS)');
        $this->newLine();

        $successRate = $this->stats['processed'] > 0 
            ? round(($this->stats['successful'] / $this->stats['processed']) * 100, 1) 
            : 0;

        $avgCostPerArticle = $this->stats['successful'] > 0 
            ? round($this->stats['total_cost'] / $this->stats['successful'], 2) 
            : 0;

        $this->table(
            ['M√©trica', 'Valor'],
            [
                ['Processados', $this->stats['processed']],
                ['‚úÖ Sucessos', $this->stats['successful']],
                ['‚ùå Falhas', $this->stats['failed']],
                ['üìà Taxa de Sucesso', $successRate . '%'],
                ['üí∞ Custo Total', $this->stats['total_cost'] . ' unidades'],
                ['üíµ Custo M√©dio/Artigo', $avgCostPerArticle . ' unidades'],
                ['‚è±Ô∏è Tempo Total', $this->stats['total_time'] . 's'],
                ['üéØ Efici√™ncia vs Standard', 'Custo 4.8x maior'],
            ]
        );

        $this->newLine();

        // An√°lise de resultados
        if ($successRate >= 90) {
            $this->info('üéâ EXCELENTE! Modelo premium resolveu os casos cr√≠ticos.');
            $this->line('üí° Isso justifica o custo alto para estes artigos espec√≠ficos.');
        } elseif ($successRate >= 70) {
            $this->warn('‚ö†Ô∏è Taxa de sucesso MODERADA com premium.');
            $this->line('üí° Poss√≠veis problemas:');
            $this->line('   ‚Ä¢ T√≠tulos mal formulados (problema na entrada)');
            $this->line('   ‚Ä¢ Temas imposs√≠veis de cobrir adequadamente');
            $this->line('   ‚Ä¢ Necessidade de ajuste nos prompts');
        } else {
            $this->error('üö® Taxa de sucesso BAIXA mesmo com premium!');
            $this->line('üí° A√á√ÉO URGENTE:');
            $this->line('   ‚Ä¢ Revisar TODOS os t√≠tulos destes artigos');
            $this->line('   ‚Ä¢ Verificar logs detalhados dos erros');
            $this->line('   ‚Ä¢ Considerar que alguns artigos podem ser invi√°veis');
            $this->line('   ‚Ä¢ N√£o continuar gastando at√© resolver o problema raiz');
        }

        $this->newLine();
        $this->warn('üí∞ AN√ÅLISE DE CUSTO:');
        
        $equivalentStandard = round($this->stats['total_cost'] / 1.0, 0);
        $equivalentIntermediate = round($this->stats['total_cost'] / 2.3, 0);

        $this->line("   Com este custo, voc√™ poderia ter gerado:");
        $this->line("   ‚Ä¢ {$equivalentStandard} artigos com modelo STANDARD");
        $this->line("   ‚Ä¢ {$equivalentIntermediate} artigos com modelo INTERMEDIATE");
        $this->newLine();

        // Status geral do sistema
        $this->info('üìä STATUS GERAL DO SISTEMA:');
        
        $pendingCount = TempArticle::pending()->count();
        $failedCount = TempArticle::where('generation_status', 'failed')->count();
        $generatedCount = TempArticle::where('generation_status', 'generated')->count();
        $validatedCount = TempArticle::where('generation_status', 'validated')->count();

        $this->table(
            ['Status', 'Quantidade'],
            [
                ['Pendentes', $pendingCount],
                ['Falhados', $failedCount],
                ['Gerados (aguardando valida√ß√£o)', $generatedCount],
                ['Validados (prontos para publicar)', $validatedCount],
            ]
        );

        $this->newLine();
        $this->info('üìù PR√ìXIMAS A√á√ïES RECOMENDADAS:');

        if ($failedCount > 0) {
            $this->warn("   ‚ö†Ô∏è {$failedCount} artigos ainda falhados:");
            $this->line('      ‚Ä¢ Revisar t√≠tulos manualmente');
            $this->line('      ‚Ä¢ Verificar se s√£o temas vi√°veis');
            $this->line('      ‚Ä¢ Considerar descarte de artigos imposs√≠veis');
        }

        if ($generatedCount > 0) {
            $this->info("   ‚úÖ {$generatedCount} artigos gerados. Pr√≥ximo passo:");
            $this->line('      üì¶ php artisan temp-article:validate');
        }

        if ($validatedCount > 0) {
            $this->info("   üöÄ {$validatedCount} artigos validados. Pr√≥ximo passo:");
            $this->line('      üåê php artisan temp-article:publish');
        }

        $this->newLine();
        $this->warn('üí° RECOMENDA√á√ÉO FINAL:');
        $this->line('   Use modelo premium com MUITA MODERA√á√ÉO.');
        $this->line('   Priorize sempre: standard ‚Üí intermediate ‚Üí premium (√∫ltima inst√¢ncia)');
    }
}